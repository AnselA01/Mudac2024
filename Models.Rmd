---
title: "Models"
output: html_document
date: "2024-04-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidymodels)
library(tidymodels)
library(ISLR2)
tidymodels_prefer()

set.seed(12345)
```

```{r}
big_data4<- read.csv("~/Desktop/data_big3.csv")

has_na <- any(is.na(data$col1))

big_data5<-big_data4|>
  select( !c(`CORN..GRAIN...YIELD..MEASURED.IN.BU...ACRE`,`CORN..SILAGE...YIELD..MEASURED.IN.TONS...ACRE`, `Turkeys`, ))

big_data_split <- initial_split(big_data5, prop=0.8)

Big_data_train_tbl <- training(big_data_split)
Big_data_test_tbl <- testing(big_data_split)
```

```{r}
Big_data_train_tbl

```


```{r}
Big_data_train_tbl_filtered <- na.omit(Big_data_train_tbl)
Big_data_test_tbl_filtered <-  na.omit(Big_data_test_tbl)
```


```{r, Soy Beans}
lasso_model <- 
  linear_reg(mixture = 1, penalty = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("glmnet")

lasso_recipe <- recipe(formula = `SOYBEANS...YIELD..MEASURED.IN.BU...ACRE` ~ ., data = Big_data_train_tbl_filtered ) %>%
  step_dummy(all_nominal_predictors())|>
  #step_impute_mean(all_numeric_predictors()) %>% 
  #step_impute_mode(all_nominal_predictors())|>
  step_normalize(all_predictors())

lasso_wf <- workflow() %>% 
  add_recipe(lasso_recipe) %>% 
  add_model(lasso_model)

credit_fold <- vfold_cv(Big_data_train_tbl_filtered, v = 10)
penalty_grid <-grid_regular(penalty(range = c(3, -3)), levels = 30)

tune_res <- tune_grid(
  lasso_wf,
  resamples = credit_fold, 
  grid = penalty_grid,
  metric = "rmse"
)
autoplot(tune_res)

```{r}
(best_penalty <- select_best(tune_res, metric = "rsq"))

lasso_final_wf <- finalize_workflow(lasso_wf, best_penalty)
lasso_final_fit <- fit(lasso_final_wf, data = Big_data_train_tbl_filtered)

augment(lasso_final_fit, new_data = Big_data_test_tbl_filtered) %>%
  rsq(truth = `SOYBEANS...YIELD..MEASURED.IN.BU...ACRE`, estimate = .pred)

library(vip)
(gg1 <- extract_fit_parsnip(lasso_final_fit) %>%
  vip()+
  ylim(0,10))

```



```{r, Sugar Beats}
lasso_model <- 
  linear_reg(mixture = 1, penalty = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("glmnet")

lasso_recipe <- recipe(formula = `SUGARBEETS...YIELD..MEASURED.IN.TONS...ACRE` ~ ., data = Big_data_train_tbl_filtered ) %>%
  step_dummy(all_nominal_predictors())|>
  #step_impute_mean(all_numeric_predictors()) %>% 
  #step_impute_mode(all_nominal_predictors())|>
  step_normalize(all_predictors())

lasso_wf <- workflow() %>% 
  add_recipe(lasso_recipe) %>% 
  add_model(lasso_model)

credit_fold <- vfold_cv(Big_data_train_tbl_filtered, v = 10)
penalty_grid <-grid_regular(penalty(range = c(3, -3)), levels = 30)

tune_res <- tune_grid(
  lasso_wf,
  resamples = credit_fold, 
  grid = penalty_grid,
  metric = "rmse"
)
autoplot(tune_res)

(best_penalty <- select_best(tune_res, metric = "rsq"))

lasso_final_wf <- finalize_workflow(lasso_wf, best_penalty)
lasso_final_fit <- fit(lasso_final_wf, data = Big_data_train_tbl_filtered)

augment(lasso_final_fit, new_data = Big_data_test_tbl_filtered) %>%
  rsq(truth = `SUGARBEETS...YIELD..MEASURED.IN.TONS...ACRE`, estimate = .pred)

library(vip)
(gg1 <- extract_fit_parsnip(lasso_final_fit) %>%
  vip()+
  ylim(0,10))

```



```{r, CORN, just add the corn bit}
lasso_model <- 
  linear_reg(mixture = 1, penalty = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("glmnet")

lasso_recipe <- recipe(formula = `SUGARBEETS...YIELD..MEASURED.IN.TONS...ACRE` ~ ., data = Big_data_train_tbl_filtered ) %>%
  step_dummy(all_nominal_predictors())|>
  #step_impute_mean(all_numeric_predictors()) %>% 
  #step_impute_mode(all_nominal_predictors())|>
  step_normalize(all_predictors())

lasso_wf <- workflow() %>% 
  add_recipe(lasso_recipe) %>% 
  add_model(lasso_model)

credit_fold <- vfold_cv(Big_data_train_tbl_filtered, v = 10)
penalty_grid <-grid_regular(penalty(range = c(3, -3)), levels = 30)

tune_res <- tune_grid(
  lasso_wf,
  resamples = credit_fold, 
  grid = penalty_grid,
  metric = "rmse"
)
autoplot(tune_res)

(best_penalty <- select_best(tune_res, metric = "rsq"))

lasso_final_wf <- finalize_workflow(lasso_wf, best_penalty)
lasso_final_fit <- fit(lasso_final_wf, data = Big_data_train_tbl_filtered)

augment(lasso_final_fit, new_data = Big_data_test_tbl_filtered) %>%
  rsq(truth = `SUGARBEETS...YIELD..MEASURED.IN.TONS...ACRE`, estimate = .pred)

library(vip)
(gg1 <- extract_fit_parsnip(lasso_final_fit) %>%
  vip()+
  ylim(0,10))

```

